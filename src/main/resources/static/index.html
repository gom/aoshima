<!DOCTYPE html>
<html>
<head>
    <title>aoshima</title>
    <link rel="stylesheet" href="webjars/bootstrap/3.3.7-1/css/bootstrap.min.css"></link>
    <script src="webjars/jquery/3.1.1-1/jquery.min.js"></script>
    <script>

        function clear_cache(event) {
            $.ajax({
                type : 'delete',
                url  : '/clear_cache',
                data: event.data.query,
                contentType: 'application/json',
                dataType: 'json',
                success: function(data) {
                    load();
                },
                error: function(e) {
                    console.log(e);

                },
                complete: function() {
                    console.log("complete");
                }
            });
        }

        function get_cache(event) {
            $.ajax({
                type : 'post',
                url  : '/get_cache',
                data: event.data.query,
                contentType: 'application/json',
                dataType: 'json',
                success: function(data) {
                    //window.alert(JSON.stringify(data));
                    var blob = new Blob([JSON.stringify(data)], {type: 'text/plain'})
                    var link = document.createElement('a')
                    link.href = URL.createObjectURL(blob)
                    link.download = 'cache.json';
                    link.click();
                },
                error: function(e) {
                    console.log(e);
                },
                complete: function() {
                    console.log("complete");
                }
            });

        }

        function load() {
            var listCacheHandler = function (rows) {
                $("#cache-list").empty();
                for (var i = 0; i < rows.length; i++) {
                    var tr = document.createElement("tr");
                    var td = document.createElement("td");
                    $(td).text(rows[i]);
                    $(tr).append(td);

                    var td = document.createElement("td");
                    var button = document.createElement("button");
                    $(button).attr("type", "button");
                    $(button).attr("class", "btn btn-default");
                    $(button).text("get cache");
                    $(button).click({query: rows[i]}, get_cache);
                    $(td).append(button);
                    $(tr).append(td);

                    var td = document.createElement("td");
                    var button = document.createElement("button");
                    $(button).attr("type", "button");
                    $(button).attr("class", "btn btn-success");
                    $(button).text("clear cache");
                    $(button).click({query: rows[i]}, clear_cache);
                    $(td).append(button);
                    $(tr).append(td);
                    $("#cache-list").append(tr);
                }
            };
            $.get("/list_cache", null, listCacheHandler, "json");
        }

        function clear_all_cache() {
            $.ajax({
                type : 'delete',
                url  : '/clear_all_cache',
                contentType: 'application/json',
                dataType: 'json',
                success: function(data) {
                    $("#cache-list").empty();
                },
                error: function(e) {
                    console.log(e);

                },
                complete: function() {
                    console.log("complete");
                }
            });
        }


    </script>
</head>

<body onLoad="load()">

    <div class="container">
        <h4>clear all cache</h4>
        <button type="button" onclick="clear_all_cache()" class="btn btn-success">clear all cache</button>

        <h4>cache list</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>presto query</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="cache-list"></tbody>
        </table>
    </div>

</body>

</html>